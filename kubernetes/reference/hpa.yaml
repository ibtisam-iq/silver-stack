apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: webapp-hpa                       # Name of the HPA object
  namespace: default                     # ğŸ”¥ Must be in the same namespace as the Deployment it targets
  labels:
    app: webapp
    environment: production

spec:
  scaleTargetRef:                        # ğŸ“Œ This tells HPA *what* to scale
    apiVersion: apps/v1                  # Must match the target object
    kind: Deployment                     # Could also be StatefulSet, ReplicaSet, etc.
    name: webapp-deployment              # Target object name (must exist)
                                         # namespace: not mentioned, not a key here.

  minReplicas: 2                         # ğŸ§Š Lower limit of pods - ensures availability
  maxReplicas: 10                        # ğŸ”¥ Upper limit - prevents over-scaling

  metrics:
    # ğŸ’» Scale based on CPU utilization %
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization                # ğŸ‘ˆ Uses percentage of CPU request (not absolute value)
        averageUtilization: 70          # If average CPU > 70%, trigger scaling

    # ğŸ§  Scale based on memory utilization %
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization                # ğŸ‘ˆ Uses percentage of memory request
        averageUtilization: 80          # If memory > 80%, HPA considers scaling up

    # ğŸ§ ğŸ§  Scale based on absolute memory usage (not %)
  - type: Resource
    resource:
      name: memory
      target:
        type: AverageValue              # ğŸ‘ˆ Use exact memory usage across pods
        averageValue: 500Mi             # If each pod uses over 500MiB on average â†’ scale

  behavior:                              # ğŸ›ï¸ Fine-tune how scaling happens
    scaleUp:
      stabilizationWindowSeconds: 30     # â³ Wait this long before considering another scale-up
      selectPolicy: Max                  # ğŸ§  If multiple policies match, pick the most aggressive
      policies:
        - type: Percent
          value: 100                     # ğŸ”º Double the current replicas (100% increase)
          periodSeconds: 15              # in a 15-second window
        - type: Pods
          value: 4                       # Or add max 4 pods in a 15s window

    scaleDown:
      stabilizationWindowSeconds: 60     # â³ Delay scale-down decisions to avoid rapid drops
      selectPolicy: Min                  # ğŸ§  Be conservative â€” pick the gentlest downscale
      policies:
        - type: Percent
          value: 50                      # ğŸ”» Reduce by 50% at most
          periodSeconds: 60              # Check every 60s
        - type: Pods
          value: 2                       # Or remove max 2 pods in 60s
